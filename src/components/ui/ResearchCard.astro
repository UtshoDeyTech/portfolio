---
import type { ResearchPublication } from '@/data/research';

interface Props {
  item: ResearchPublication;
}

const { item } = Astro.props;

// Builder pattern: only include elements if data exists
const hasTitle = item.title && item.title.trim() !== '';
const hasAuthors = item.authors && item.authors.length > 0;
const hasPublicationDate = item.publication_date && item.publication_date.trim() !== '';
const hasInstitution = item.institution && item.institution.trim() !== '';
const hasBook = item.book && item.book.trim() !== '';
const hasPublisher = item.publisher && item.publisher.trim() !== '';
const hasPages = item.pages && item.pages.trim() !== '';
const hasPublicationType = item.publication_type && item.publication_type.trim() !== '';
const hasDescription = item.description && item.description.trim() !== '';
const hasAbstract = item.abstract && item.abstract.trim() !== '';
const hasObjectives = item.objectives && item.objectives.length > 0;
const hasMethods = item.methods_used && item.methods_used.length > 0;
const hasModels = item.models_tested && item.models_tested.length > 0;
const hasDataset = item.dataset && item.dataset.trim() !== '';
const hasDatasetSource = item.dataset_source && item.dataset_source.trim() !== '';
const hasMetrics = item.metrics && item.metrics.length > 0;
const hasEvalMetrics = item.evaluation_metrics && item.evaluation_metrics.length > 0;
const hasComparisonModels = item.comparison_models && item.comparison_models.length > 0;
const hasResultsSummary = item.results_summary && item.results_summary.trim() !== '';
const hasHighlights = item.highlights && item.highlights.length > 0;
const hasTags = item.tags && item.tags.length > 0;
const hasUrl = item.url && item.url.trim() !== '';
const hasPdfUrl = item.pdf_url && item.pdf_url.trim() !== '';
const hasGithubUrl = item.github_url && item.github_url.trim() !== '';
const hasDoi = item.doi && item.doi.trim() !== '';
const hasCitations = item.citations && item.citations > 0;

// Combine metrics
const allMetrics = [
  ...(item.metrics || []),
  ...(item.evaluation_metrics || [])
];
const hasAnyMetrics = allMetrics.length > 0;

// Format authors
const formatAuthors = () => {
  if (!hasAuthors) return '';
  const authors = item.authors!;
  if (authors.length === 1) return authors[0];
  if (authors.length === 2) return `${authors[0]} and ${authors[1]}`;
  const lastAuthor = authors[authors.length - 1];
  const otherAuthors = authors.slice(0, -1).join(', ');
  return `${otherAuthors}, and ${lastAuthor}`;
};

// Get publication type color
const getTypeColor = () => {
  if (!hasPublicationType) return 'badge-neutral';
  const type = item.publication_type!.toLowerCase();
  if (type.includes('journal')) return 'badge-primary';
  if (type.includes('conference')) return 'badge-secondary';
  if (type.includes('thesis')) return 'badge-accent';
  return 'badge-neutral';
};
---

<article class='research-card bg-base-100 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 border-l-4 border-primary overflow-hidden'>
  <!-- Header Section -->
  <div class='bg-gradient-to-r from-base-200 to-base-100 p-6 border-b border-base-300'>
    {hasTitle && (
      <h3 class='text-2xl font-bold text-base-content mb-4 leading-tight'>
        {item.title}
      </h3>
    )}

    <!-- Authors -->
    {hasAuthors && (
      <div class='mb-3'>
        <p class='text-base-content/80 italic'>
          {formatAuthors()}
        </p>
      </div>
    )}

    <!-- Publication Details -->
    <div class='flex flex-wrap gap-3 items-center text-sm text-base-content/70'>
      {hasPublicationType && (
        <span class={`badge ${getTypeColor()} badge-lg`}>
          {item.publication_type}
        </span>
      )}

      {hasPublicationDate && (
        <span class='flex items-center gap-1'>
          <svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'></path>
          </svg>
          {item.publication_date}
        </span>
      )}

      {hasInstitution && (
        <span class='flex items-center gap-1'>
          <svg class='w-4 h-4' fill='currentColor' viewBox='0 0 20 20'>
            <path d='M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3z'></path>
          </svg>
          {item.institution}
        </span>
      )}

      {hasCitations && (
        <span class='flex items-center gap-1 bg-success/10 text-success px-2 py-1 rounded-md'>
          <svg class='w-4 h-4' fill='currentColor' viewBox='0 0 20 20'>
            <path d='M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z'></path>
          </svg>
          {item.citations} citations
        </span>
      )}
    </div>

    <!-- Publication Venue -->
    <div class='mt-3 space-y-1'>
      {hasBook && (
        <p class='text-sm text-base-content/70'>
          <span class='font-semibold'>Published in:</span> {item.book}
        </p>
      )}
      {hasPublisher && (
        <p class='text-sm text-base-content/70'>
          <span class='font-semibold'>Publisher:</span> {item.publisher}
        </p>
      )}
      {hasPages && (
        <p class='text-sm text-base-content/70'>
          <span class='font-semibold'>Pages:</span> {item.pages}
        </p>
      )}
    </div>
  </div>

  <!-- Content Section -->
  <div class='p-6 space-y-5'>
    <!-- Abstract/Description -->
    {(hasDescription || hasAbstract) && (
      <div class='bg-base-200 rounded-lg p-4 border-l-2 border-primary/50'>
        <h4 class='text-sm font-semibold text-base-content mb-2 uppercase tracking-wide flex items-center gap-2'>
          <svg class='w-4 h-4 text-primary' fill='currentColor' viewBox='0 0 20 20'>
            <path fill-rule='evenodd' d='M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z' clip-rule='evenodd'></path>
          </svg>
          Abstract
        </h4>
        <p class='text-sm text-base-content/80 leading-relaxed'>
          {hasAbstract ? item.abstract : item.description}
        </p>
      </div>
    )}

    <!-- Objectives -->
    {hasObjectives && (
      <div>
        <h4 class='text-sm font-semibold text-base-content mb-2 uppercase tracking-wide flex items-center gap-2'>
          <svg class='w-4 h-4 text-secondary' fill='currentColor' viewBox='0 0 20 20'>
            <path d='M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z'></path>
          </svg>
          Research Objectives
        </h4>
        <ul class='space-y-2'>
          {item.objectives!.map((objective, index) => (
            <li class='flex items-start gap-2 text-sm text-base-content/80'>
              <span class='flex-shrink-0 w-6 h-6 bg-secondary/10 text-secondary rounded-full flex items-center justify-center text-xs font-bold'>
                {index + 1}
              </span>
              <span>{objective}</span>
            </li>
          ))}
        </ul>
      </div>
    )}

    <!-- Methods -->
    {hasMethods && (
      <div>
        <h4 class='text-sm font-semibold text-base-content mb-2 uppercase tracking-wide flex items-center gap-2'>
          <svg class='w-4 h-4 text-accent' fill='currentColor' viewBox='0 0 20 20'>
            <path fill-rule='evenodd' d='M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z' clip-rule='evenodd'></path>
          </svg>
          Methods & Approaches
        </h4>
        <div class='flex flex-wrap gap-2'>
          {item.methods_used!.map((method) => (
            <span class='px-3 py-1.5 bg-accent/10 text-accent text-xs font-medium rounded-md border border-accent/20'>
              {method}
            </span>
          ))}
        </div>
      </div>
    )}

    <!-- Dataset & Models -->
    <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
      {/* Dataset */}
      {(hasDataset || hasDatasetSource) && (
        <div class='bg-warning/5 border border-warning/20 rounded-lg p-4'>
          <h4 class='text-sm font-semibold text-warning mb-2 flex items-center gap-2'>
            <svg class='w-4 h-4' fill='currentColor' viewBox='0 0 20 20'>
              <path d='M3 12v3c0 1.657 3.134 3 7 3s7-1.343 7-3v-3c0 1.657-3.134 3-7 3s-7-1.343-7-3z'></path>
              <path d='M3 7v3c0 1.657 3.134 3 7 3s7-1.343 7-3V7c0 1.657-3.134 3-7 3S3 8.657 3 7z'></path>
              <path d='M17 5c0 1.657-3.134 3-7 3S3 6.657 3 5s3.134-3 7-3 7 1.343 7 3z'></path>
            </svg>
            Dataset
          </h4>
          {hasDataset && (
            <p class='text-sm text-base-content/80 font-medium'>{item.dataset}</p>
          )}
          {hasDatasetSource && (
            <a
              href={item.dataset_source}
              target='_blank'
              rel='noopener noreferrer'
              class='text-xs text-warning hover:underline mt-1 inline-block'
            >
              View Source â†’
            </a>
          )}
        </div>
      )}

      {/* Models Tested */}
      {hasModels && (
        <div class='bg-info/5 border border-info/20 rounded-lg p-4'>
          <h4 class='text-sm font-semibold text-info mb-2 flex items-center gap-2'>
            <svg class='w-4 h-4' fill='currentColor' viewBox='0 0 20 20'>
              <path d='M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z'></path>
            </svg>
            Models Tested
          </h4>
          <div class='flex flex-wrap gap-1'>
            {item.models_tested!.map((model) => (
              <span class='px-2 py-0.5 bg-info/20 text-info text-xs font-medium rounded'>
                {model}
              </span>
            ))}
          </div>
        </div>
      )}
    </div>

    {/* Comparison Models & Metrics */}
    {(hasComparisonModels || hasAnyMetrics) && (
      <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
        {hasComparisonModels && (
          <div>
            <h4 class='text-sm font-semibold text-base-content mb-2'>Compared Against:</h4>
            <div class='flex flex-wrap gap-2'>
              {item.comparison_models!.map((model) => (
                <span class='px-2.5 py-1 bg-base-200 text-base-content/70 text-xs rounded-md border border-base-300'>
                  {model}
                </span>
              ))}
            </div>
          </div>
        )}

        {hasAnyMetrics && (
          <div>
            <h4 class='text-sm font-semibold text-base-content mb-2'>Evaluation Metrics:</h4>
            <div class='flex flex-wrap gap-2'>
              {allMetrics.map((metric) => (
                <span class='px-2.5 py-1 bg-success/10 text-success text-xs rounded-md border border-success/20 font-medium'>
                  {metric}
                </span>
              ))}
            </div>
          </div>
        )}
      </div>
    )}

    <!-- Results Summary -->
    {hasResultsSummary && (
      <div class='bg-gradient-to-r from-success/5 to-success/10 border border-success/30 rounded-lg p-4'>
        <h4 class='text-sm font-semibold text-success mb-2 flex items-center gap-2'>
          <svg class='w-4 h-4' fill='currentColor' viewBox='0 0 20 20'>
            <path fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z' clip-rule='evenodd'></path>
          </svg>
          Results Summary
        </h4>
        <p class='text-sm text-base-content/80 leading-relaxed'>
          {item.results_summary}
        </p>
      </div>
    )}

    <!-- Highlights -->
    {hasHighlights && (
      <div>
        <h4 class='text-sm font-semibold text-base-content mb-2 uppercase tracking-wide flex items-center gap-2'>
          <svg class='w-4 h-4 text-primary' fill='currentColor' viewBox='0 0 20 20'>
            <path d='M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z'></path>
          </svg>
          Key Highlights
        </h4>
        <ul class='space-y-2'>
          {item.highlights!.map((highlight) => (
            <li class='flex items-start gap-2 text-sm text-base-content/80'>
              <svg class='w-5 h-5 text-primary mt-0.5 flex-shrink-0' fill='currentColor' viewBox='0 0 20 20'>
                <path fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z' clip-rule='evenodd'></path>
              </svg>
              <span>{highlight}</span>
            </li>
          ))}
        </ul>
      </div>
    )}

    <!-- Tags -->
    {hasTags && (
      <div>
        <div class='flex flex-wrap gap-2'>
          {item.tags!.map((tag) => (
            <span class='px-3 py-1 bg-primary/10 text-primary text-xs font-medium rounded-full border border-primary/20 hover:bg-primary/20 transition-colors'>
              #{tag}
            </span>
          ))}
        </div>
      </div>
    )}
  </div>

  <!-- Footer with Links -->
  {(hasUrl || hasPdfUrl || hasGithubUrl || hasDoi) && (
    <div class='bg-base-200 px-6 py-4 border-t border-base-300 flex flex-wrap gap-3'>
      {hasUrl && (
        <a
          href={item.url}
          target='_blank'
          rel='noopener noreferrer'
          class='btn btn-sm btn-primary gap-2'
        >
          <svg class='w-4 h-4' fill='currentColor' viewBox='0 0 20 20'>
            <path d='M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z'></path>
          </svg>
          View Publication
        </a>
      )}

      {hasPdfUrl && (
        <a
          href={item.pdf_url}
          target='_blank'
          rel='noopener noreferrer'
          class='btn btn-sm btn-secondary gap-2'
        >
          <svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z'></path>
          </svg>
          Download PDF
        </a>
      )}

      {hasGithubUrl && (
        <a
          href={item.github_url}
          target='_blank'
          rel='noopener noreferrer'
          class='btn btn-sm btn-outline gap-2'
        >
          <svg class='w-4 h-4' fill='currentColor' viewBox='0 0 24 24'>
            <path d='M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z'></path>
          </svg>
          View Code
        </a>
      )}

      {hasDoi && (
        <a
          href={`https://doi.org/${item.doi}`}
          target='_blank'
          rel='noopener noreferrer'
          class='btn btn-sm btn-accent gap-2'
        >
          <svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1'></path>
          </svg>
          DOI
        </a>
      )}
    </div>
  )}
</article>

<style>
  .research-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .research-card:hover {
    transform: translateY(-4px);
  }
</style>
